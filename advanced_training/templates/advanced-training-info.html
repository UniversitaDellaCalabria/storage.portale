<!-- MODALE CAMBIO STATO -->
<div
  class="modal fade"
  id="statusChangeModal"
  tabindex="-1"
  aria-labelledby="statusChangeModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="statusChangeModalLabel">
          Cambio Stato Master
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>

      <form method="post" action="" id="statusChangeForm">
        {% csrf_token %}

        <div class="modal-body">
          <div class="mb-3">
            <label for="status_select" class="form-label"
              >Seleziona nuovo stato</label
            >
            <select
              class="form-control"
              id="status_select"
              name="status_cod"
              required
            >
              <option value="">- Seleziona stato -</option>
              {% for status in available_statuses %}
              <option value="{{ status.status_cod }}">
                {{ status.status_desc }}
              </option>
              {% endfor %}
            </select>
          </div>

          <div class="mb-3">
            <label for="motivazione" class="form-label">Motivazione *</label>
            <textarea
              class="form-control"
              id="motivazione"
              name="motivazione"
              rows="4"
              required
              placeholder="Inserisci la motivazione del cambio stato..."
            ></textarea>
          </div>
        </div>

        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            Annulla
          </button>
          <button
            type="submit"
            class="btn btn-primary"
            id="confirmStatusChange"
          >
            Conferma Cambio Stato
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  // Aggiorna l'action del form quando viene selezionato uno stato
  document
    .getElementById("status_select")
    ?.addEventListener("change", function () {
      const form = document.getElementById("statusChangeForm");
      const masterId = "{{ master.id }}";
      const statusCod = this.value;

      if (statusCod) {
        form.action = `/management/advanced-training/${masterId}/status/${statusCod}/`;
      } else {
        form.action = "";
      }
    });

  // Validazione form prima dell'invio
  document
    .getElementById("statusChangeForm")
    ?.addEventListener("submit", function (e) {
      const statusSelect = document.getElementById("status_select");
      const motivazione = document.getElementById("motivazione");

      if (!statusSelect.value) {
        e.preventDefault();
        alert("Seleziona uno stato");
        statusSelect.focus();
        return false;
      }

      if (!motivazione.value.trim()) {
        e.preventDefault();
        alert("Inserisci una motivazione");
        motivazione.focus();
        return false;
      }
    });

  // Reset del form quando si chiude la modale
  document
    .getElementById("statusChangeModal")
    ?.addEventListener("hidden.bs.modal", function () {
      const form = document.getElementById("statusChangeForm");
      form?.reset();
      form.action = "";
    });
</script>
