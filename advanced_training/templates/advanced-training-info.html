{% extends "cds_brochure_unique_form.html" %} {% load i18n %} {% load static %}
{% block title %}{% endblock title %} {% block form_container %}
<div class="card-wrapper card-space">
  <div class="card card-bg no-after">
    <div class="card-body mt-4">
      <div class="d-flex justify-content-between align-items-center mb-4 pb-4">
        <h3 style="font-weight: normal" class="mb-0">
          {% blocktrans %}Scheda Master{% endblocktrans %}
        </h3>
      </div>

      <!-- STATO E CAMBIO STATO -->
      <div class="mb-4">
        <div class="d-flex align-items-center mb-3">
          <span class="mr-2"><strong>Stato attuale:</strong></span>
          <span class="badge badge-{{ status_badge_class }} badge-pill">
            {{ current_status_description }}
          </span>
        </div>

        {% if master.pk and available_statuses %}
        <button
          type="button"
          class="btn btn-sm btn-outline-primary"
          data-toggle="modal"
          data-target="#statusModal"
        >
          <i class="fas fa-exchange-alt"></i> Cambia Stato
        </button>
        {% endif %}
      </div>

      <!-- MESSAGGI -->
      {% if messages %}
      <div class="mb-3">
        {% for message in messages %}
        <div
          class="alert alert-{{ message.tags }} alert-dismissible fade show"
          role="alert"
        >
          {{ message|safe }}
          <button
            type="button"
            class="close"
            data-dismiss="alert"
            aria-label="Close"
          >
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        {% endfor %}
      </div>
      {% endif %}

      <!-- NAV TABS -->
      <ul class="nav nav-tabs nav-justified" id="master-tabs" role="tablist">
        {% for tab, form in forms.items %} {% with trimmed_tab=tab|cut:" " %}
        <li class="nav-item">
          <a
            class="nav-link {% if forloop.first and not last_viewed_tab or last_viewed_tab == tab %}active{% endif %}"
            id="{{trimmed_tab}}-nav-item"
            data-toggle="tab"
            href="#{{trimmed_tab}}-tab"
            role="tab"
            aria-controls="{{trimmed_tab}}-tab"
            aria-selected="{% if forloop.first %}true{% else %}false{% endif %}"
          >
            {{tab}}
          </a>
        </li>
        {% endwith %} {% endfor %}
      </ul>

      <!-- TAB CONTENT -->
      <div class="tab-content pt-2" id="master-tabsContent">
        {% for tab, form in forms.items %} {% with trimmed_tab=tab|cut:" " %}
        <div
          class="tab-pane p-4 mt-3 fade {% if forloop.first and not last_viewed_tab or last_viewed_tab == tab %}show active{% endif %}"
          id="{{trimmed_tab}}-tab"
          role="tabpanel"
          aria-labelledby="{{trimmed_tab}}-nav-item"
        >
          <form method="post" enctype="multipart/form-data" novalidate>
            {% csrf_token %} {% if form.management_form %}
            <div style="display: none">{{ form.management_form }}</div>

            {% if tab == "Incarichi Didattici" %}
            <table class="table table-striped table-bordered">
              <thead>
                <tr>
                  <th>Modulo</th>
                  <th>Numero ore</th>
                  <th>Docente</th>
                  <th>Qualifica</th>
                  <th>Ente</th>
                  <th>Tipologia</th>
                  <th>Elimina</th>
                </tr>
              </thead>
              <tbody>
                {% for f in form %}
                <tr>
                  {{ f.id }}
                  <td>{{ f.modulo }}</td>
                  <td>{{ f.num_ore }}</td>
                  <td>{{ f.docente }}</td>
                  <td>{{ f.qualifica }}</td>
                  <td>{{ f.ente }}</td>
                  <td>{{ f.tipologia }}</td>
                  <td>{{ f.DELETE }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>

            {% elif tab == "Piano Didattico" %}
            <table class="table table-striped table-bordered">
              <thead>
                <tr>
                  <th>Modulo</th>
                  <th>SSD</th>
                  <th>Numero ore</th>
                  <th>CFU</th>
                  <th>Verifica finale</th>
                  <th>Elimina</th>
                </tr>
              </thead>
              <tbody>
                {% for f in form %}
                <tr>
                  {{ f.id }}
                  <td>{{ f.modulo }}</td>
                  <td>{{ f.ssd }}</td>
                  <td>{{ f.num_ore }}</td>
                  <td>{{ f.cfu }}</td>
                  <td>{{ f.verifica_finale }}</td>
                  <td>{{ f.DELETE }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>

            {% elif tab == "Partner" %}
            <table class="table table-striped table-bordered">
              <thead>
                <tr>
                  <th>Denominazione</th>
                  <th>Tipologia</th>
                  <th>Sito web</th>
                  <th>Elimina</th>
                </tr>
              </thead>
              <tbody>
                {% for f in form %}
                <tr>
                  {{ f.id }}
                  <td>{{ f.denominazione }}</td>
                  <td>{{ f.tipologia }}</td>
                  <td>{{ f.sito_web }}</td>
                  <td>{{ f.DELETE }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>

            {% elif tab == "Consiglio Scientifico Esterno" %}
            <table class="table table-striped table-bordered">
              <thead>
                <tr>
                  <th>Nome</th>
                  <th>Ruolo</th>
                  <th>Ente</th>
                  <th>Elimina</th>
                </tr>
              </thead>
              <tbody>
                {% for f in form %}
                <tr>
                  {{ f.id }}
                  <td>{{ f.nome_cons }}</td>
                  <td>{{ f.ruolo_cons }}</td>
                  <td>{{ f.ente_cons }}</td>
                  <td>{{ f.DELETE }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>

            {% elif tab == "Consiglio Scientifico Interno" %}
            <table class="table table-striped table-bordered">
              <thead>
                <tr>
                  <th>Matricola</th>
                  <th>Nome</th>
                  <th>Elimina</th>
                </tr>
              </thead>
              <tbody>
                {% for f in form %}
                <tr>
                  {{ f.id }}
                  <td>{{ f.matricola_cons }}</td>
                  <td>{{ f.nome_origine_cons }}</td>
                  <td>{{ f.DELETE }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
            {% endif %} {% else %} {% include "form_template.html" with
            form=form %} {% endif %}

            <input type="hidden" name="tab_form_dict_key" value="{{tab}}" />

            <div class="mt-3 d-flex justify-content-between">
              <div>
                <button type="submit" class="btn btn-primary">
                  Salva {{ tab }}
                </button>
              </div>
              <div class="btn-group" role="group">
                {% if not forloop.first %}
                <a
                  href="{% url 'advanced-training:management:advanced-training' %}"
                  class="btn btn-outline-secondary btn-sm"
                >
                  {% trans "Torna alla lista" %}
                </a>
                {% endif %}
              </div>
            </div>
          </form>
        </div>
        {% endwith %} {% endfor %}
      </div>
    </div>
  </div>
</div>

<!-- MODALE CAMBIO STATO -->
{% if master.pk and available_statuses %}
<div
  class="modal fade"
  id="statusModal"
  tabindex="-1"
  role="dialog"
  aria-labelledby="statusModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="statusModalLabel">Cambia Stato Master</h5>
        <button
          type="button"
          class="close"
          data-dismiss="modal"
          aria-label="Close"
        >
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <form method="post" id="statusChangeForm">
        {% csrf_token %}
        <div class="modal-body">
          <div class="form-group">
            <label for="nuovoStato">Seleziona nuovo stato:</label>
            <select
              class="form-control"
              id="nuovoStato"
              name="nuovo_stato"
              required
            >
              <option value="">-- Seleziona --</option>
              {% for status in available_statuses %}
              <option value="{{ status.status_cod }}">
                {{ status.status_desc }}
              </option>
              {% endfor %}
            </select>
          </div>
          <div class="form-group">
            <label for="motivazione"
              >Motivazione: <span class="text-danger">*</span></label
            >
            <textarea
              class="form-control"
              id="motivazione"
              name="motivazione"
              rows="4"
              required
              placeholder="Inserisci la motivazione del cambio di stato..."
            ></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">
            Annulla
          </button>
          <button type="submit" class="btn btn-primary">
            Conferma Cambio Stato
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  document
    .getElementById("statusChangeForm")
    .addEventListener("submit", function (e) {
      e.preventDefault();

      const nuovoStato = document.getElementById("nuovoStato").value;
      const motivazione = document.getElementById("motivazione").value.trim();

      if (!nuovoStato) {
        alert("Seleziona un nuovo stato");
        return;
      }

      if (!motivazione) {
        alert("La motivazione Ã¨ obbligatoria");
        return;
      }

      // Crea un form temporaneo per inviare la richiesta POST
      const form = document.createElement("form");
      form.method = "POST";
      form.action =
        "{% url 'advanced-training:management:alta-formazione-status-change' master.pk 'STATUS_PLACEHOLDER' %}".replace(
          "STATUS_PLACEHOLDER",
          nuovoStato
        );

      // Aggiungi il token CSRF
      const csrfInput = document.createElement("input");
      csrfInput.type = "hidden";
      csrfInput.name = "csrfmiddlewaretoken";
      csrfInput.value = document.querySelector(
        "[name=csrfmiddlewaretoken]"
      ).value;
      form.appendChild(csrfInput);

      // Aggiungi la motivazione
      const motivazioneInput = document.createElement("input");
      motivazioneInput.type = "hidden";
      motivazioneInput.name = "motivazione";
      motivazioneInput.value = motivazione;
      form.appendChild(motivazioneInput);

      document.body.appendChild(form);
      form.submit();
    });
</script>
{% endif %} {% endblock form_container %}
