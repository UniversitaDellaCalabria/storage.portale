{% extends "cds_brochure_unique_form.html" %} {% load i18n %} {% load static %}
{% block title %}{% endblock title %} {% block form_container %}
<div class="card-wrapper card-space">
  <div class="card card-bg no-after">
    <div class="card-body mt-4">
      <div class="d-flex justify-content-between align-items-center mb-4 pb-4">
        <h3 style="font-weight: normal" class="mb-0">
          {% blocktrans %}Scheda Master{% endblocktrans %}
        </h3>
        <div class="d-flex align-items-center mb-3">
          <span class="mr-2"><strong>Stato attuale:</strong></span>
          <span class="badge badge-{{ status_badge_class }} badge-pill">
            {{ current_status_description }}
          </span>
        </div>
      </div>

      <!-- AVVISO FINESTRA TEMPORALE -->
      {% if not has_active_window %}
      <div class="alert alert-warning" role="alert">
        <i class="fas fa-exclamation-triangle"></i>
        <strong>Attenzione:</strong> Non è presente una finestra temporale attiva. 
        Le modifiche e l'invio in revisione/correzione non sono disponibili.
      </div>
      {% endif %}

      <!-- CAMBIO STATO -->
      <div class="mb-4">
        {% if master.pk and available_statuses %}
        <div class="d-flex justify-content-between">

          <div>
            <!-- Approva e Rifiuta: sempre disponibili se non readonly -->
            {% if not is_readonly %}
            <button type="button" class="btn btn-sm btn-success mr-2"
              data-toggle="modal" data-target="#statusModal"
              data-status-cod="3" data-status-label="Approva">
              <i class="fas fa-check"></i> Approva
            </button>

            <button type="button" class="btn btn-sm btn-danger mr-2"
              data-toggle="modal" data-target="#statusModal"
              data-status-cod="4" data-status-label="Rifiuta">
              <i class="fas fa-times"></i> Rifiuta
            </button>

            <!-- Correggi: solo con finestra temporale attiva -->
            <button type="button" class="btn btn-sm btn-warning"
              data-toggle="modal" data-target="#statusModal"
              data-status-cod="2" data-status-label="Correggi">
              <i class="fas fa-pencil-alt"></i> Correggi
            </button>
            {% endif %}
          </div>

          <!-- Pulsante Valida: solo con finestra temporale attiva e stati 0,2,None -->
          {% if can_send_validation %}
          <button
              type="button"
              class="btn btn-sm btn-warning ms-2"
              data-toggle="modal"
              data-target="#statusModal"
              data-status-cod="1"
              data-status-label="Valida">
              <i class="fas fa-paper-plane"></i> Valida
          </button>
          {% elif current_status_cod in "0,2" or current_status_cod == None %}
          <button
              type="button"
              class="btn btn-sm btn-secondary ms-2"
              disabled
              title="Finestra temporale non attiva">
              <i class="fas fa-paper-plane"></i> Valida
          </button>
          {% endif %}

        </div>
        {% endif %}
      </div>

      <!-- MESSAGGI -->
      {% if messages %}
      <div class="mb-3">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
          {{ message|safe }}
          <button type="button" class="close" data-dismiss="alert">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        {% endfor %}
      </div>
      {% endif %}

      <!-- NAV TABS -->
      <ul class="nav nav-tabs nav-justified" id="master-tabs" role="tablist">
        {% for tab, form in forms.items %}
        {% with trimmed_tab=tab|cut:" " %}
        <li class="nav-item">
          <a class="nav-link 
             {% if forloop.first and not last_viewed_tab or last_viewed_tab == tab %}active{% endif %}"
             id="{{trimmed_tab}}-nav-item"
             data-toggle="tab"
             href="#{{trimmed_tab}}-tab"
             role="tab"
             aria-controls="{{trimmed_tab}}-tab"
             aria-selected="{% if forloop.first %}true{% else %}false{% endif %}">
             {{tab}}
          </a>
        </li>
        {% endwith %}
        {% endfor %}
      </ul>

      <!-- TAB PANES -->
      <div class="tab-content pt-2" id="master-tabsContent">
        {% for tab, form in forms.items %}
        {% with trimmed_tab=tab|cut:" " %}

        <div
          class="tab-pane fade p-4 mt-3 {% if forloop.first and not last_viewed_tab or last_viewed_tab == tab %}show active{% endif %} {% if is_readonly or not has_active_window %}readonly{% endif %}"
          id="{{trimmed_tab}}-tab"
          role="tabpanel"
          aria-labelledby="{{trimmed_tab}}-nav-item"
        >

          <form method="post" enctype="multipart/form-data" novalidate>
            {% csrf_token %}

            {% if form.management_form %}
            <div style="display:none">{{ form.management_form }}</div>

            <!-- TABELLE SPECIALI -->
            {% if tab == "Incarichi Didattici" %}
            <table class="table table-striped table-bordered">
              <thead>
                <tr>
                  <th>Modulo</th><th>Numero ore</th><th>Docente</th><th>Qualifica</th>
                  <th>Ente</th><th>Tipologia</th><th>Elimina</th>
                </tr>
              </thead>
              <tbody>
                {% for f in form %}
                <tr>
                  {{ f.id }}
                  <td>{{ f.modulo }}</td>
                  <td>{{ f.num_ore }}</td>
                  <td>{{ f.docente }}</td>
                  <td>{{ f.qualifica }}</td>
                  <td>{{ f.ente }}</td>
                  <td>{{ f.tipologia }}</td>
                  <td>{% if not is_readonly and has_active_window %}{{ f.DELETE }}{% endif %}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>

            {% elif tab == "Piano Didattico" %}
            <table class="table table-striped table-bordered">
              <thead>
                <tr>
                  <th>Modulo</th><th>SSD</th><th>Numero ore</th><th>CFU</th><th>Verifica finale</th><th>Elimina</th>
                </tr>
              </thead>
              <tbody>
                {% for f in form %}
                <tr>
                  {{ f.id }}
                  <td>{{ f.modulo }}</td>
                  <td>{{ f.ssd }}</td>
                  <td>{{ f.num_ore }}</td>
                  <td>{{ f.cfu }}</td>
                  <td>{{ f.verifica_finale }}</td>
                  <td>{% if not is_readonly and has_active_window %}{{ f.DELETE }}{% endif %}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>

            {% elif tab == "Partner" %}
            <table class="table table-striped table-bordered">
              <thead>
                <tr>
                  <th>Denominazione</th><th>Tipologia</th><th>Sito web</th><th>Elimina</th>
                </tr>
              </thead>
              <tbody>
                {% for f in form %}
                <tr>
                  {{ f.id }}
                  <td>{{ f.denominazione }}</td>
                  <td>{{ f.tipologia }}</td>
                  <td>{{ f.sito_web }}</td>
                  <td>{% if not is_readonly and has_active_window %}{{ f.DELETE }}{% endif %}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>

            {% elif tab == "Consiglio Scientifico Esterno" %}
            <table class="table table-striped table-bordered">
              <thead>
                <tr>
                  <th>Nome</th><th>Ruolo</th><th>Ente</th><th>Elimina</th>
                </tr>
              </thead>
              <tbody>
                {% for f in form %}
                <tr>
                  {{ f.id }}
                  <td>{{ f.nome_cons }}</td>
                  <td>{{ f.ruolo_cons }}</td>
                  <td>{{ f.ente_cons }}</td>
                  <td>{% if not is_readonly and has_active_window %}{{ f.DELETE }}{% endif %}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>

            {% elif tab == "Consiglio Scientifico Interno" %}
            <table class="table table-striped table-bordered">
              <thead>
                <tr>
                  <th>Matricola</th><th>Nome</th><th>Elimina</th>
                </tr>
              </thead>
              <tbody>
                {% for f in form %}
                <tr>
                  {{ f.id }}
                  <td>{{ f.matricola_cons }}</td>
                  <td>{{ f.nome_origine_cons }}</td>
                  <td>{% if not is_readonly and has_active_window %}{{ f.DELETE }}{% endif %}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>

            {% endif %}
            {% else %}
              {% include "form_template.html" with form=form %}
            {% endif %}

            <input type="hidden" name="tab_form_dict_key" value="{{tab}}">

            <div class="mt-3 d-flex justify-content-between">
              <!-- Mostra pulsante Salva solo se non readonly E finestra attiva -->
              {% if not is_readonly and has_active_window %}
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i> Salva {{ tab }}
              </button>
              {% elif not is_readonly and not has_active_window %}
              <button type="button" class="btn btn-secondary" disabled 
                      title="Finestra temporale non attiva">
                <i class="fas fa-save"></i> Salva {{ tab }}
              </button>
              {% endif %}

              <div class="btn-group" role="group">
                <a href="{% url 'advanced-training:management:advanced-training' %}"
                   class="btn btn-outline-secondary btn-sm">
                  <i class="fas fa-arrow-left"></i> {% trans "Torna alla lista" %}
                </a>
              </div>
            </div>

          </form>

        </div>
        {% endwith %}
        {% endfor %}
      </div>

    </div>
  </div>
</div>

<!-- MODALE CAMBIO STATO -->
{% if master.pk and available_statuses %}
<div class="modal fade" id="statusModal" tabindex="-1" role="dialog">
  <div class="modal-dialog"><div class="modal-content">

    <div class="modal-header">
      <h5 class="modal-title">Conferma <span id="actionLabel"></span> Stato Master</h5>
      <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
    </div>

    <form method="post" id="statusChangeForm">
      {% csrf_token %}
      <input type="hidden" name="nuovo_stato" id="nuovoStatoHidden" value="">

      <div class="modal-body">
        <div class="form-group">
          <label for="motivazione">Motivazione: <span class="text-danger">*</span></label>
          <textarea id="motivazione" name="motivazione" class="form-control" rows="4"
            required placeholder="Inserisci la motivazione..."></textarea>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Annulla</button>
        <button type="submit" class="btn btn-primary" id="confirmButton">Conferma Cambio Stato</button>
      </div>

    </form>

  </div></div>
</div>

<script>
  $("#statusModal").on("show.bs.modal", function (event) {
    let btn = $(event.relatedTarget);
    let cod = btn.data("status-cod");
    let label = btn.data("status-label");

    $(this).find("#nuovoStatoHidden").val(cod);
    $(this).find("#actionLabel").text(label);
    $(this).find("#confirmButton").text("Conferma " + label);
    $(this).find("#motivazione").val("");

    let base = "{% url 'advanced-training:management:advanced-training-status-change' master.pk 'STATUS_PLACEHOLDER' %}";
    let newUrl = base.replace("STATUS_PLACEHOLDER", cod);
    $("#statusChangeForm").attr("action", newUrl);
  });

  document.getElementById("statusChangeForm").addEventListener("submit", function (e) {
    if (!document.getElementById("motivazione").value.trim()) {
      e.preventDefault();
      alert("La motivazione è obbligatoria");
    }
  });

  const READ_ONLY = {% if is_readonly %}true{% else %}false{% endif %};
  const HAS_ACTIVE_WINDOW = {% if has_active_window %}true{% else %}false{% endif %};
</script>
{% endif %}

<style>
.readonly * {
  pointer-events: none !important;
}
.readonly input,
.readonly select,
.readonly textarea {
  background-color: #f8f9fa !important;
}
</style>

{% endblock form_container %}