{% extends "cds_brochure_unique_form.html" %}
{% load i18n %}
{% load static %}

{% block title %}{% endblock title %}

{% block form_container %}
<div class="card-wrapper card-space">
  <div class="card card-bg no-after">
    <div class="card-body mt-4">
      
      <!-- HEADER -->
      <div class="d-flex justify-content-between align-items-center mb-4 pb-4">
        <h3 style="font-weight: normal" class="mb-0">
          {% blocktrans %}Scheda Master{% endblocktrans %}
        </h3>
        <div class="d-flex align-items-center mb-3">
          <span class="mr-2"><strong>Stato attuale:</strong></span>
          <span class="badge badge-{{ status_badge_class }} badge-pill">
            {{ current_status_description }}
          </span>
        </div>
      </div>

      <!-- AVVISO FINESTRA TEMPORALE -->
      {% if not has_active_window and current_status_cod == "0" or current_status_cod == "2" or current_status_cod == None %}
      <div class="alert alert-warning" role="alert">
        <i class="fas fa-exclamation-triangle"></i>
        <strong>Attenzione:</strong> Non è presente una finestra temporale attiva. 
        L'invio in validazione non è disponibile.
      </div>
      {% endif %}

      <!-- CAMBIO STATO -->
      <div class="mb-4">
        {% if master.pk and available_statuses %}
        <div class="d-flex justify-content-between">

          <div>
            <!-- Pulsanti Validatore: sempre disponibili per i validatori -->
            {% if user_is_validator %}
            <button type="button" class="btn btn-sm btn-success mr-2"
              data-toggle="modal" data-target="#statusModal"
              data-status-cod="3" data-status-label="Approva">
              <i class="fas fa-check"></i> Approva
            </button>

            <button type="button" class="btn btn-sm btn-danger mr-2"
              data-toggle="modal" data-target="#statusModal"
              data-status-cod="4" data-status-label="Rifiuta">
              <i class="fas fa-times"></i> Rifiuta
            </button>

            <button type="button" class="btn btn-sm btn-warning"
              data-toggle="modal" data-target="#statusModal"
              data-status-cod="2" data-status-label="Correggi">
              <i class="fas fa-pencil-alt"></i> Correggi
            </button>
            {% endif %}
          </div>

          <!-- Pulsante Valida: solo con finestra temporale attiva e stati 0,2,None -->
          {% if can_send_validation %}
          <button
              type="button"
              class="btn btn-sm btn-warning ms-2"
              data-toggle="modal"
              data-target="#statusModal"
              data-status-cod="1"
              data-status-label="Valida">
              <i class="fas fa-paper-plane"></i> Valida
          </button>
          {% elif current_status_cod == "0" or current_status_cod == "2" or current_status_cod == None %}
          <button
              type="button"
              class="btn btn-sm btn-secondary ms-2"
              disabled
              title="Finestra temporale non attiva">
              <i class="fas fa-paper-plane"></i> Valida
          </button>
          {% endif %}

        </div>
        {% endif %}
      </div>

      <!-- MESSAGGI -->
      {% if messages %}
      <div class="mb-3">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
          {{ message|safe }}
          <button type="button" class="close" data-dismiss="alert">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        {% endfor %}
      </div>
      {% endif %}

      <!-- NAV TABS -->
      <ul class="nav nav-tabs nav-justified" id="master-tabs" role="tablist">
        <li class="nav-item">
          <a class="nav-link {% if last_viewed_tab == 'Dati generali' %}active{% endif %}"
             id="dati-generali-nav-item"
             data-toggle="tab"
             href="#dati-generali-tab"
             role="tab"
             aria-controls="dati-generali-tab"
             aria-selected="{% if last_viewed_tab == 'Dati generali' %}true{% else %}false{% endif %}">
             Dati generali
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if last_viewed_tab == 'Incarichi Didattici' %}active{% endif %}"
             id="incarichi-didattici-nav-item"
             data-toggle="tab"
             href="#incarichi-didattici-tab"
             data-tab-name="Incarichi Didattici"
             role="tab"
             aria-controls="incarichi-didattici-tab"
             aria-selected="false">
             Incarichi Didattici
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if last_viewed_tab == 'Piano Didattico' %}active{% endif %}"
             id="piano-didattico-nav-item"
             data-toggle="tab"
             href="#piano-didattico-tab"
             data-tab-name="Piano Didattico"
             role="tab"
             aria-controls="piano-didattico-tab"
             aria-selected="false">
             Piano Didattico
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if last_viewed_tab == 'Partner' %}active{% endif %}"
             id="partner-nav-item"
             data-toggle="tab"
             href="#partner-tab"
             data-tab-name="Partner"
             role="tab"
             aria-controls="partner-tab"
             aria-selected="false">
             Partner
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if last_viewed_tab == 'Consiglio Scientifico Esterno' %}active{% endif %}"
             id="consiglio-scientifico-esterno-nav-item"
             data-toggle="tab"
             href="#consiglio-scientifico-esterno-tab"
             data-tab-name="Consiglio Scientifico Esterno"
             role="tab"
             aria-controls="consiglio-scientifico-esterno-tab"
             aria-selected="false">
             Consiglio Scientifico Esterno
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if last_viewed_tab == 'Consiglio Scientifico Interno' %}active{% endif %}"
             id="consiglio-scientifico-interno-nav-item"
             data-toggle="tab"
             href="#consiglio-scientifico-interno-tab"
             data-tab-name="Consiglio Scientifico Interno"
             role="tab"
             aria-controls="consiglio-scientifico-interno-tab"
             aria-selected="false">
             Consiglio Scientifico Interno
          </a>
        </li>
      </ul>

      <!-- TAB PANES -->
      <div class="tab-content pt-2" id="master-tabsContent">
        
        <!-- TAB DATI GENERALI (sempre caricato) -->
        <div class="tab-pane fade p-4 mt-3 {% if last_viewed_tab == 'Dati generali' %}show active{% endif %} {% if is_readonly and not user_is_validator %}readonly{% endif %}"
          id="dati-generali-tab"
          role="tabpanel"
          aria-labelledby="dati-generali-nav-item">

          <form method="post" enctype="multipart/form-data" novalidate>
            {% csrf_token %}
            {% include "form_template.html" with form=dati_generali_form %}
            <input type="hidden" name="tab_form_dict_key" value="Dati generali">

            <div class="mt-3 d-flex justify-content-between">
              {% if not is_readonly or user_is_validator %}
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i> Salva Dati generali
              </button>
              {% endif %}

              <div class="btn-group" role="group">
                <a href="{% url 'advanced-training:management:advanced-training' %}"
                   class="btn btn-outline-secondary btn-sm">
                  <i class="fas fa-arrow-left"></i> {% trans "Torna alla lista" %}
                </a>
              </div>
            </div>
          </form>

        </div>

        <!-- TAB LAZY LOADING (placeholder) -->
        <div class="tab-pane fade p-4 mt-3 {% if last_viewed_tab == 'Incarichi Didattici' %}show active{% endif %}"
          id="incarichi-didattici-tab"
          role="tabpanel"
          aria-labelledby="incarichi-didattici-nav-item"
          data-loaded="false">
          <div class="text-center py-5">
            <div class="spinner-border" role="status">
              <span class="sr-only">Caricamento...</span>
            </div>
            <p class="mt-3">Caricamento dati in corso...</p>
          </div>
        </div>

        <div class="tab-pane fade p-4 mt-3 {% if last_viewed_tab == 'Piano Didattico' %}show active{% endif %}"
          id="piano-didattico-tab"
          role="tabpanel"
          aria-labelledby="piano-didattico-nav-item"
          data-loaded="false">
          <div class="text-center py-5">
            <div class="spinner-border" role="status">
              <span class="sr-only">Caricamento...</span>
            </div>
            <p class="mt-3">Caricamento dati in corso...</p>
          </div>
        </div>

        <div class="tab-pane fade p-4 mt-3 {% if last_viewed_tab == 'Partner' %}show active{% endif %}"
          id="partner-tab"
          role="tabpanel"
          aria-labelledby="partner-nav-item"
          data-loaded="false">
          <div class="text-center py-5">
            <div class="spinner-border" role="status">
              <span class="sr-only">Caricamento...</span>
            </div>
            <p class="mt-3">Caricamento dati in corso...</p>
          </div>
        </div>

        <div class="tab-pane fade p-4 mt-3 {% if last_viewed_tab == 'Consiglio Scientifico Esterno' %}show active{% endif %}"
          id="consiglio-scientifico-esterno-tab"
          role="tabpanel"
          aria-labelledby="consiglio-scientifico-esterno-nav-item"
          data-loaded="false">
          <div class="text-center py-5">
            <div class="spinner-border" role="status">
              <span class="sr-only">Caricamento...</span>
            </div>
            <p class="mt-3">Caricamento dati in corso...</p>
          </div>
        </div>

        <div class="tab-pane fade p-4 mt-3 {% if last_viewed_tab == 'Consiglio Scientifico Interno' %}show active{% endif %}"
          id="consiglio-scientifico-interno-tab"
          role="tabpanel"
          aria-labelledby="consiglio-scientifico-interno-nav-item"
          data-loaded="false">
          <div class="text-center py-5">
            <div class="spinner-border" role="status">
              <span class="sr-only">Caricamento...</span>
            </div>
            <p class="mt-3">Caricamento dati in corso...</p>
          </div>
        </div>

      </div>

    </div>
  </div>
</div>

<!-- MODALE CAMBIO STATO -->
{% if master.pk and available_statuses %}
<div class="modal fade" id="statusModal" tabindex="-1" role="dialog">
  <div class="modal-dialog"><div class="modal-content">

    <div class="modal-header">
      <h5 class="modal-title">Conferma <span id="actionLabel"></span> Stato Master</h5>
      <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
    </div>

    <form method="post" id="statusChangeForm">
      {% csrf_token %}
      <input type="hidden" name="nuovo_stato" id="nuovoStatoHidden" value="">

      <div class="modal-body">
        <div class="form-group">
          <label for="motivazione">Motivazione: <span class="text-danger">*</span></label>
          <textarea id="motivazione" name="motivazione" class="form-control" rows="4"
            required placeholder="Inserisci la motivazione..."></textarea>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Annulla</button>
        <button type="submit" class="btn btn-primary" id="confirmButton">Conferma Cambio Stato</button>
      </div>

    </form>

  </div></div>
</div>

<script>
  const MASTER_ID = {{ master.pk|default:"null" }};
  const IS_READONLY = {% if is_readonly %}true{% else %}false{% endif %};
  const USER_IS_VALIDATOR = {% if user_is_validator %}true{% else %}false{% endif %};
  const LAST_VIEWED_TAB = "{{ last_viewed_tab|escapejs }}";
  
  // Gestione modale stato
  $("#statusModal").on("show.bs.modal", function (event) {
    let btn = $(event.relatedTarget);
    let cod = btn.data("status-cod");
    let label = btn.data("status-label");

    $(this).find("#nuovoStatoHidden").val(cod);
    $(this).find("#actionLabel").text(label);
    $(this).find("#confirmButton").text("Conferma " + label);
    $(this).find("#motivazione").val("");

    let base = "{% url 'advanced-training:management:advanced-training-status-change' master.pk 'STATUS_PLACEHOLDER' %}";
    let newUrl = base.replace("STATUS_PLACEHOLDER", cod);
    $("#statusChangeForm").attr("action", newUrl);
  });

  document.getElementById("statusChangeForm")?.addEventListener("submit", function (e) {
    if (!document.getElementById("motivazione").value.trim()) {
      e.preventDefault();
      alert("La motivazione è obbligatoria");
    }
  });

  // LAZY LOADING DEI TAB
  $(document).ready(function() {
    // Carica il tab attivo all'avvio se non è "Dati generali"
    if (LAST_VIEWED_TAB !== "Dati generali" && MASTER_ID) {
      const tabElement = $(`[data-tab-name="${LAST_VIEWED_TAB}"]`);
      if (tabElement.length) {
        loadTabContent(LAST_VIEWED_TAB);
      }
    }

    // Event listener per il cambio tab
    $('a[data-toggle="tab"]').on('show.bs.tab', function(e) {
      const tabName = $(e.target).data('tab-name');
      
      // Se è Dati generali, non fare nulla (già caricato)
      if (!tabName) return;
      
      const tabId = $(e.target).attr('href');
      const tabPane = $(tabId);
      
      // Se già caricato, non ricaricare
      if (tabPane.data('loaded') === 'true') return;
      
      // Carica il contenuto
      loadTabContent(tabName);
    });
  });

  function loadTabContent(tabName) {
    console.log('=== LOADING TAB ===');
    console.log('Tab Name:', tabName);
    console.log('Master ID:', MASTER_ID);
    
    if (!MASTER_ID) {
      console.error('Master ID non disponibile');
      return;
    }

    // Trova il tab pane usando l'attributo data-tab-name o l'aria-labelledby
    const tabLink = $(`a[data-tab-name="${tabName}"]`);
    const tabPaneId = tabLink.attr('href');
    console.log('Tab Link found:', tabLink.length > 0);
    console.log('Tab Pane ID:', tabPaneId);
    
    if (!tabPaneId) {
      console.error('Tab pane ID non trovato per:', tabName);
      return;
    }
    
    const tabPane = $(tabPaneId);
    console.log('Tab Pane found:', tabPane.length > 0);
    
    // Mostra loader
    tabPane.html(`
      <div class="text-center py-5">
        <div class="spinner-border" role="status">
          <span class="sr-only">Caricamento...</span>
        </div>
        <p class="mt-3">Caricamento dati in corso...</p>
      </div>
    `);

    // Costruisci l'URL usando Django URL reverse
    const url = "{% url 'advanced-training:management:advanced-training-load-tab' master.pk 'TAB_PLACEHOLDER' %}".replace('TAB_PLACEHOLDER', encodeURIComponent(tabName));
    console.log('URL:', url);
    
    fetch(url, {
      method: 'GET',
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
      },
    })
    .then(response => {
      console.log('Response status:', response.status);
      console.log('Response OK:', response.ok);
      if (!response.ok) {
        return response.text().then(text => {
          console.error('Response body:', text);
          throw new Error(`HTTP error! status: ${response.status}`);
        });
      }
      return response.json();
    })
    .then(data => {
      console.log('Data received:', data);
      if (data.html) {
        console.log('HTML length:', data.html.length);
        tabPane.html(data.html);
        tabPane.data('loaded', 'true');
        
        // Applica readonly se necessario
        if (IS_READONLY && !USER_IS_VALIDATOR) {
          tabPane.addClass('readonly');
        }
        console.log('Tab loaded successfully');
      } else {
        throw new Error('Risposta non valida dal server');
      }
    })
    .catch(error => {
      console.error('Errore completo:', error);
      tabPane.html(`
        <div class="alert alert-danger" role="alert">
          <i class="fas fa-exclamation-circle"></i>
          Errore nel caricamento dei dati. Riprova più tardi.
          <br><small>${error.message}</small>
          <br><small>Controlla la console per maggiori dettagli</small>
        </div>
      `);
    });
  }
</script>
{% endif %}

<style>
.readonly * {
  pointer-events: none !important;
}
.readonly input,
.readonly select,
.readonly textarea {
  background-color: #f8f9fa !important;
}
</style>

{% endblock form_container %}